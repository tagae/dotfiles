#!/bin/bash

source ~/.dotfiles/bin/lib/interaction.sh
source ~/.dotfiles/bin/lib/files.sh

usage="Usage: $(basename "$0") [-p <platform>] <path>"

while getopts ":p:" opt; do
    case $opt in
        p)
            [[ "$OPTARG" =~ ^(Linux|Darwin)$ ]] || \
                error "Unknown platform '$OPTARG'."

            suffix=" ($OPTARG)"
            shift
            ;;
        \?)
            error "Unknown option -$OPTARG." "$usage"
            ;;
        :)
            error "Option -$OPTARG requires an argument." "$usage"
            ;;
    esac
    shift
done

while [ $# -gt 0 ]; do
    dotfile="$1"
    shift

    [ -e "$dotfile" ] || \
        error "File '$dotfile' does not exist."

    [[ $(basename $dotfile) =~ ^\.?(.+) ]]
    basename=${BASH_REMATCH[1]}

    [ "$basename" = "$(basename "$dotfile")" ] && \
        warning "File '$dotfile' does not seem to be a dotfile."

    [ "$(realdir "$dotfile")" != $HOME ] && \
        warning "Dotfile '$dotfile' does not reside in your home directory."

    targetFile="$basename$suffix"

    mv -i "$dotfile" ~/.dotfiles/"$targetFile" || exit $?

    pushd ~/.dotfiles/ > /dev/null
    shouldStash=false
    [ -n "$(git status -suno)" ] && shouldStash=true
    $shouldStash && git stash save --quiet "Prior to importing $basename."
    git add "$targetFile"
    git commit -m "Imported $basename."
    $shouldStash && git stash pop --quiet
    popd > /dev/null
done
