#!/bin/bash

source ~/.dotfiles/bin/lib/interaction.sh
source ~/.dotfiles/bin/lib/files.sh

usage="Usage: $(basename "$0") [-p <platform>] <path>"

while getopts ":p:" opt; do
    case $opt in
        p)
            [[ "$OPTARG" =~ ^(Linux|Darwin)$ ]] || \
                error "Unknown platform '$OPTARG'."

            suffix=" ($OPTARG)"
            shift
            ;;
        \?)
            error "Unknown option -$OPTARG." "$usage"
            ;;
        :)
            error "Option -$OPTARG requires an argument." "$usage"
            ;;
    esac
    shift
done

while [ $# -gt 0 ]; do
    file="$1"
    shift

    [ -e "$file" ] || \
        error "File '$file' does not exist."

    [[ $(realpath "$file") =~ ^$HOME/(.+) ]] || \
        warning "Dotfile '$file' does not reside in your home directory."
    relname=${BASH_REMATCH[1]}

    [[ $relname =~ ^\.(.+) ]] || \
        warning "File '$file' does not seem to be a dotfile."
    dotfile=${BASH_REMATCH[1]}
    finalname="$dotfile$suffix"

    ensureDir ~/.dotfiles/"$(dirname "$dotfile")"
    mv -i "$file" ~/.dotfiles/"$finalname" || exit $?

    pushd ~/.dotfiles/ > /dev/null
    shouldStash=false
    [ -n "$(git status -suno)" ] && shouldStash=true
    $shouldStash && git stash save --quiet "Prior to importing '$finalname'."
    git add "$finalname"
    git commit -m "Imported '$finalname'."
    $shouldStash && git stash pop --quiet
    popd > /dev/null
done
